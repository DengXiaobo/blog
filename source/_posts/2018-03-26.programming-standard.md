---
title: 后端编程规范
date: 2018-03-26 21:31:36
description: "后端编程规范，包括代码、测试、数据库、异常、注释等"
categories: [技术总结]
tags: [Java, MySQL, Test]
top: true
---

## 编程规范

### 命名规范

#### 总体命名规则
  - 提倡`英文`命名，切忌英文和拼音混用
  - 所有名称的字符范围为：A-Z, a-z, 0-9 和_(下划线)，不建议使用其他字符作为名称
  - 名称应该清晰明了，能够准确表达事物的含义，最好可读，遵循“见名知意”的原则，尽量少用缩写，如: User，Customer

#### 包名
  - 包名必须`小写`
  - 包名尽量简洁，一个单词或缩写
  - 包名不能以数字开头，尽量只包含字母
  - 包的命名遵循以下格式，以公司的域名加上对该包内容的描述，中间用英文的半角句点隔开，如：com.proginn.web.servlet

#### 类名
  - `大驼峰式命名`，即单词首字母大写，如：UserService
  - 单词间不要使用下划线
  - 类的命名力求短而精炼，示意明确，能够准确的描述该对象

#### 方法/函数
  - 方法的命名力求言简意赅，表意明确
  - 方法的命名首字母小写，建议统一使用`lowerCamelCase风格`
  - 方法的名称主要由两部分构成，动词部分和名词部分
  - 一般名称的前缀都是有第一规律的，如is（判断）、get（得到），set（设置）等

#### 常量/变量名
  - 常量命名应该全部使用`大写字母`
  - 单词间用`下划线`隔开
  - 力求语义表达完整清楚，不要嫌名字长
  - 变量采用`小驼峰式命名`，变量名首字母必须为`小写字母`
  - 尽量使用英文作为变量名，变量命名要有意义，拒绝无意义的变量a，a1，b，k等；

### 排版规范

#### 缩进
  - 程序块要采用缩进风格编写，缩进的空格数为`4`个
  - 缩进必须用space，不能使用tab键
  - 可以在eclipse或其他开发工具配置一个tab用`4`个space代替

#### 空格/空行
  - 相对独立的程序块之间、变量说明之后必须加空行
  - 编码过程中每一个方法之间留一行空行
  - 要适时的进行换行，操作符放在新行之首，划分出的新行要进行适当的缩进，使排版整齐，语句可读

#### 书写格式
  - 不允许把多个短语句写在一行中，即一行只写一条语
  - 在程序代码间一般不要连续留空两行
  - 若方法函数或过程中的参数较长，则要进行适当的划分
  - if、for、do、while、case、switch、default等语句自占一行，且if、for、do、while等语句的执行语句部分无论多少都要加括号{}
  - 函数或过程的开始、结构的定义及循环、判断等语句中的代码都要采用缩进风格
  - 单行程序以小于`80`字符为宜，不要写得过长

### 注释规范

#### 通用
  - 一般情况下，源程序有效注释量必须在`20％`以上
  - 类名，功能方法接口名称必须有注释
  - 所有共有变量和共有方法都需要注释
  - 复杂代码逻辑必须有注释
  - 代码注释不超过一行使用 `//`，超过一行使用 `/* */`
  - 将注释与其上面的代码用空行隔开
  - 每次提交代码到仓库应有相关注释，能够完整描述本次提交变更的内容
  - 注释不宜太多也不能太少，注释语言必须准确、易懂、简洁，防止注释二义性

#### 类的注释
  - 类/源文件实现之前，需要用注释来描述一些必要的信息，包括：类的主要功能、作者、日期、版本号等

#### 方法/函数的注释
  - 方法/函数的目的或者功能
  - 如果该方法/函数含有参数，还应该描述清楚每一个参数的含义
  - 如果方法抛出异常，则描述什么情况下会抛出这个异常
  - 对于有返回值的方法，还应该对方法的返回值有充分的描述，描述清楚方法在什么情况下返回什么值

#### 属性的注释
  - 变量、常量、宏的注释应放在其上方相邻位置或右方
  - 在每一个类的属性前面都应该跟上相应的注释，描述该属性的具体含义
  - 全局变量要有较详细的注释，包括对其功能、取值范围、哪些函数或过程存取它以及存取时注意事项等的说明

#### 数据结构注释
  - 所有的枚举类型字段必须要有注释，说明每个数据项的用途
  - 对数据结构的注释应放在其上方相邻位置，不可放在下面；对结构中的每个域的注释放在此域的右方

### 代码实现与设计

#### 变量
  - 去掉没必要的公共变量，来降低模块间的耦合度
  - 仔细定义并明确公共变量的含义、作用、取值范围及公共变量间的关系
  - 当向公共变量传递数据时，防止赋与不合理的值或越界等现象发生
  - 避免局部变量与公共变量同名
  - 严禁使用未经初始化的变量作为右值

#### 数据结构
  - 不同结构间的关系不要过于复杂
  - 尽量减少没有必要的数据类型默认转换与强制转换
  - 设计结构的功能要单一，是针对一种事务的抽象

#### 方法/函数
  - 原则上一个函数/方法仅完成一件功能
  - 对所调用函数的错误返回码要仔细、全面地处理
  - 明确函数/方法功能，精确地实现函数设计
  - 避免将函数/方法的参数作为工作变量直接使用
  - 单个函数/方法的代码规模尽量限制在`200`行以内
  - 避免函数/方法中不必要语句，防止程序中的垃圾代码
  - 避免把没有关联的语句放到一个函数/方法中
  - 减少函数/方法本身或函数间的递归调用
  - 降低函数/方法间的耦合度，并提高独立性以及代码可读性、效率和可维护性

#### 代码前置后置
  - 需要简化前台、视图层、控制层代码的数量和复杂度它们仅用来做交互性的操作
  - 复杂的业务逻辑应在`Service层`来完成

#### 多线程/并发
  - 获取单例对象需要保证`线程安全`，其中的方法也要保证线程安全
  - 创建线程或线程池时请指定有意义的线程名称，方便出错时回溯
  - 线程资源必须通过线程池提供，不允许在应用中自行显式创建线程
  - 对多个资源、数据库表、对象同时加锁时，需要保持一致的加锁顺序，避免造成死锁
  - 能用无锁数据结构，就不要用锁；能锁区块，就不要锁整个方法体；能用对象锁，就不要用类锁

#### 接口设计
  - 一切基于接口开发，提供业务逻辑服务必须提供接口
  - 接口方法参数超过`3`个，需要转换为DTO属性，对象入参
  - 对外提供服务接口JSON返回结构\[状态,错误代码,错误描述,数据\]
  - 尽量使用缓存：配置类数据使用内存（一级）缓存；业务类数据使用redis（二级）缓存
  - 禁止使用Map作为入参出参，会增加接口复杂度，容易造成序列化、反序列化失败
  - 接口可以新增入参，出参；如果接口逻辑不兼容修改，必须使用版本号，并通知下游修改

#### 安全与性能
  - 用户请求传入的`任何参数`必须做有效性验证
  - 禁止向HTML页面输出未经安全过滤或未正确转义的用户数据
  - 升级相关的依赖包或者配置文件具有拦截作用来起到XSS防护
  - 对外部传入参数进行合法性检查，非特殊情况，必须使用参数化方式传递变量参数，敏感表用存储过程操作，限制连接sql权限起到Sql注入防范
  - 注意CSRF防护和文件安全防护，避免全站通用的cookie，严格设置cookie的域

#### 代码效率
  - 尽量减少循环嵌套层次
  - 在保证软件系统的正确性、稳定性、可读性及可测性的前提下，提高代码效率
  - `局部效率应为全局效率服务`，不能因为提高局部效率而对全局效率造成影响
  - 在保证程序质量的前提下，通过`压缩代码量、去掉不必要代码以及减少不必要的局部和全局变量`，来提高空间效率
  - 在多重循环中，应将`最忙的循环放在最内层`，减少CPU切入循环层的次数
  - `避免循环体内含判断语句`，应将循环语句置于判断语句的代码块之中
  - 尽量用`乘法或其它方法代替除法`，特别是浮点运算中的除法

### 测试规范

#### 测试编写
  - 测试相关代码和配置应该放在 src/test 目录下
  - 测试代码应该采用Junit方式编写
  - 编程的同时要为单元测试选择恰当的测试点，并仔细构造测试代码、测试用例，同时给出明确的注释说明
  - 使用断言来发现软件问题，提高代码可测性
  - 正式软件产品中应把断言及其它调测代码去掉，来提高运行性能

#### 单元测试
  - 单元测试要求至少达到语句覆盖，来提高测试覆盖率
  - 单元测试开始要跟踪每一条语句，并观察数据流及变量的变化
  - 坚持在编码阶段就对代码进行彻底的单元测试，不要等以后的测试工作来发现问题

#### 集成测试
  - 在进行集成测试/系统联调之前，要构造好测试环境、测试项目及测试用例，同时仔细分析并优化测试用例，以提高测试效率

### 异常日志规范

#### 异常处理
  - 所有的错误代码采用Enum定义
  - 无论发生何种异常，应尽可能保证申请的资源（包括但不限于内存资源）被释放
  - `异常不要用来做流程控制，条件控制`，因为异常的处理效率比条件分支低
  - 最外层的业务使用者，必须处理异常，将其转化为用户可以理解的内容
  - 有try块放到了事务代码中，catch异常后，如果需要回滚事务，一定要注意手动回滚事务
  - finally 块必须对资源对象、流对象进行关闭，有异常也要做 try-catch
  - 不能在finally块中使用return，finally块中的return返回后方法结束执行，不会再执行try块中的return语句
  - 尽量`不要直接抛出原始异常`，异常需要被注释并计入日志

#### 日志规范
  - 业务关键环节必须打印日志，但禁止打印密码等敏感信息
  - 日志变量往往不变，最好定义成不可变常量，变量名用大写
  - 避免重复打印日志，浪费磁盘空间
  - 外部接口调用必须打印日志，并统计接口调用耗时，以便统计趋势图
  - 日志文件推荐至少保存15天，因为有些异常具备以“周”为频次发生的特点
  - error级别以上的日志，必须记录关键业务信息，如方法的入参，错误发生时的变量现场，以便回溯追踪问题
  - 尽量使用日志系统（Log4j2、Glog、Logback、Monolog等）的API，有利于维护和各个类的日志处理

### 数据库规范

#### 一般规范
  - `能用数字就不要用字符串`
  - 每个领域实体表必须有一个领域主键驱动，便于信息查询
  - SQL命名准确，功能要单一，不能包含多种含义功能，维护会更复杂
  - 字符集选择utf8mb4，Collation属性的选择utf8mb4\_general\_ci，包括表和字段
  - 数据库设计应该满足第三范式3NF，减少不必要的冗余导致的数据库操作复杂

#### 表设计规范
  - `表名不使用复数名词`，且禁用保留字，如desc、range、match、delayed等
  - 表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字
  - 表名以应用作为表前缀，后面加符合表实际意义的英文单词，例如：安全中的用户表命名为aq_user
  - DTO属性与Table字段名对应规则：DTO遵循Camel\_Case，表明对应的是 \_小写。userName = user_name
  - `表之间存在关联的时候，不需要建立外键，所有的删除关联操作都用程序来实现`
  - 表达是与否概念的字段，必须使用is_xxx的方式命名，数据类型是unsigned tinyint（ 1表示是，0表示否）
  - 小数类型为 decimal，禁止使用 float 和 double
  - 如果存储的字符串长度几乎相等，使用char定长字符串类型

#### 字段设计规范
  - 字段需要写上注释
  - 一个表中的字段不要太多，理论上不要超过`80`个
  - 数据库中所有布尔型中数值0表示为假；数值1表示为真
  - 字段尽可能有默认值，字符型的默认值为一个空字符值串，数字型的默认值为数值0
  - 字段名应尽可能用英文缩写，看到名称应该让人能够容易明白其含义，不要出现诸如lrcjkssj之类的缩写

#### 键设计规范
  - 尽可能避免使用复合键
  - 所有的键都必须唯一
  - 一个表中组合主键的字段个数尽可能少
  - 表必须要有主键，主键规则是：去掉应用前缀后的表名+\_id，例如：用户表aq\_user主键为user_id

#### 索引设计规范
  - 添加有必要的索引，如果本身存在外键关联，在外键字段上添加索引
  - 主键索引名为pk_字段名；唯一索引名为uk_字段名；普通索引名则为idx_字段名
  - `业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引`
  - 在varchar字段上建立索引时，必须指定索引长度，没必要对全字段建立索引
  - 页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决
  - 超过三个表禁止join，需要join的字段，数据类型必须绝对一致；多表关联查询时，保证被关联的字段需要有索引

#### SQL语句
  - 写SQL的时候推荐使用索引字段进行查询，避免出现模糊查询
  - 使用ISNULL()来判断是否为NULL值
  - 不得使用外键与级联，一切外键概念必须在应用层解决
  - 禁止使用存储过程，存储过程难以调试和扩展，更没有移植性
  - 在表查询中，一律不要使用 \* 作为查询的字段列表，需要哪些字段必须明确写明

#### 事务规范
  - 外部接口必须禁止在事务中
  - `禁止嵌套事务，嵌套事务不易掌控`
  - 在事务中尽量使访问的数据量最小
  - 禁止长事务，长事务切分为多个短事务
  - 不要在事务处理期间要求用户输入或消息响应